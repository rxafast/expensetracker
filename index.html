<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PocketTracker Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            text: '#f1f5f9',
                            muted: '#94a3b8'
                        }
                    },
                    fontFamily: {
                        urdu: ['"Noto Naskh Arabic"', 'serif'],
                        sans: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Naskh+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Urdu Override */
        body[dir="rtl"] { font-family: 'Noto Naskh Arabic', serif; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Calendar Styles */
        .calendar-day { min-height: 80px; }
        .calendar-day:hover { background-color: rgba(99, 102, 241, 0.05); }
    </style>
</head>
<body class="bg-gray-100 dark:bg-dark-bg text-gray-800 dark:text-dark-text h-screen flex flex-col overflow-hidden transition-colors duration-300">

    <!-- New Month Modal -->
    <div id="new-month-modal" class="fixed inset-0 bg-black/90 z-[140] hidden flex-col items-center justify-center p-6 text-center backdrop-blur-sm">
        <div class="bg-white dark:bg-dark-card p-6 rounded-2xl shadow-2xl w-full max-w-sm">
            <div class="mb-4">
                <i class="fa-solid fa-calendar-days text-4xl text-indigo-500 mb-2"></i>
                <h2 class="text-xl font-bold dark:text-white">New Month Detected!</h2>
                <p class="text-sm text-gray-500 mt-2">Your remaining balance is:</p>
                <h3 id="nm-balance" class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 my-2">Rs 0</h3>
                <p class="text-xs text-gray-400">What would you like to do?</p>
            </div>
            <div class="space-y-3">
                <button onclick="app.handleNewMonth('carry')" class="w-full bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 py-3 rounded-lg font-semibold hover:bg-indigo-200 transition-colors">
                    Carry Forward
                    <span class="block text-[10px] opacity-70 font-normal">Keep balance in wallet</span>
                </button>
                <button onclick="app.handleNewMonth('save')" class="w-full bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 py-3 rounded-lg font-semibold hover:bg-green-200 transition-colors">
                    Move to Savings
                    <span class="block text-[10px] opacity-70 font-normal">Reset balance & save it</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="camera-modal" class="fixed inset-0 bg-black/95 z-[130] hidden flex-col items-center justify-center p-4 backdrop-blur-sm">
        <div class="relative w-full max-w-md">
            <video id="camera-feed" autoplay playsinline class="w-full bg-black rounded-xl mb-6 shadow-2xl border border-gray-800"></video>
            <div class="flex justify-center gap-8 items-center">
                <button onclick="app.closeCamera()" class="bg-gray-700/50 text-white h-12 w-12 rounded-full flex items-center justify-center hover:bg-gray-600 transition-all backdrop-blur-sm">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
                <button onclick="app.capturePhoto()" class="bg-white h-16 w-16 rounded-full flex items-center justify-center border-4 border-gray-300 hover:border-indigo-500 hover:scale-105 transition-all shadow-lg shadow-white/10">
                    <div class="h-12 w-12 bg-gray-100 rounded-full border-2 border-gray-300"></div>
                </button>
                <div class="w-12"></div> <!-- Spacer for balance -->
            </div>
        </div>
    </div>

    <!-- Auth Modal (Login/Signup) - Centered -->
    <div id="auth-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[120] hidden flex items-center justify-center text-white p-4">
        <div class="bg-white dark:bg-dark-card p-8 rounded-2xl shadow-2xl w-full max-w-md text-gray-800 dark:text-white transform transition-all scale-100">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-indigo-100 dark:bg-indigo-900 rounded-full mb-4">
                    <i class="fa-solid fa-wallet text-3xl text-indigo-600 dark:text-indigo-400"></i>
                </div>
                <h2 class="text-2xl font-bold" id="auth-title">Login to Sync</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Access your data across devices</p>
            </div>
            
            <form id="auth-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Email</label>
                    <input type="email" id="auth-email" required class="w-full bg-gray-100 dark:bg-gray-800 border-none rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Password</label>
                    <input type="password" id="auth-password" required class="w-full bg-gray-100 dark:bg-gray-800 border-none rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                </div>
                
                <div class="flex justify-end">
                    <button type="button" id="auth-forgot-pass" onclick="app.handleForgotPassword()" class="text-xs text-indigo-600 dark:text-indigo-400 hover:underline hidden">Forgot Password?</button>
                </div>

                <div id="auth-error" class="text-red-500 text-sm hidden font-medium text-center bg-red-50 dark:bg-red-900/20 p-2 rounded"></div>
                
                <button type="submit" id="auth-submit-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition-colors shadow-lg shadow-indigo-500/30">
                    Login
                </button>
            </form>
            
            <div class="mt-6 text-center text-sm">
                <span id="auth-switch-text" class="text-gray-500">Don't have an account?</span>
                <button onclick="app.toggleAuthMode()" id="auth-switch-btn" class="text-indigo-600 font-bold hover:underline ml-1">Sign Up</button>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receipt-modal" class="fixed inset-0 bg-black/90 z-[110] hidden flex flex-col items-center justify-center p-4 backdrop-blur-sm">
        <div class="relative max-w-2xl w-full flex justify-center">
            <button onclick="document.getElementById('receipt-modal').classList.add('hidden')" class="absolute -top-12 right-0 text-white hover:text-gray-300 text-3xl">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <img id="receipt-image-view" src="" alt="Receipt" class="max-w-full rounded-lg shadow-2xl max-h-[80vh] object-contain bg-white">
        </div>
    </div>

    <!-- PIN Overlay -->
    <div id="pin-overlay" class="fixed inset-0 bg-gray-900 z-[100] hidden flex-col items-center justify-center text-white">
        <div class="mb-8 text-center">
            <i class="fa-solid fa-lock text-4xl mb-4 text-indigo-500"></i>
            <h2 class="text-2xl font-bold" data-i18n="privacyLock">Privacy Lock</h2>
            <p class="text-gray-400" data-i18n="enterPin">Enter your PIN to access</p>
        </div>
        <div class="flex gap-4 mb-8">
            <input type="password" id="pin-input" maxlength="4" class="bg-gray-800 border border-gray-700 text-center text-3xl tracking-[1em] rounded-lg w-48 h-16 focus:outline-none focus:border-indigo-500 transition-colors">
        </div>
        <button onclick="app.verifyPin()" class="bg-indigo-600 hover:bg-indigo-700 px-8 py-2 rounded-lg font-medium transition-colors" data-i18n="unlock">Unlock</button>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-dark-card w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold dark:text-white" data-i18n="settings">Settings</h3>
                <button onclick="app.toggleSettings()" class="text-gray-500 hover:text-gray-700 dark:hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar space-y-6">
                
                <!-- Account -->
                <div>
                    <h4 class="text-sm font-bold uppercase text-gray-500 mb-3" data-i18n="account">Account</h4>
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <div id="settings-user-details">
                            <p class="font-medium dark:text-white">User</p>
                            <p class="text-xs text-gray-500">Synced</p>
                        </div>
                        <button onclick="app.showAuthModal()" id="settings-auth-btn" class="text-sm bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 px-3 py-1 rounded font-medium hover:bg-indigo-200">Logout</button>
                    </div>
                </div>

                <!-- Security -->
                <div>
                    <h4 class="text-sm font-bold uppercase text-gray-500 mb-3" data-i18n="security">Security</h4>
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <div>
                            <p class="font-medium dark:text-white" data-i18n="appPin">App PIN</p>
                            <p class="text-xs text-gray-500" data-i18n="protectData">Protect your data</p>
                        </div>
                        <button onclick="app.setPin()" class="text-sm text-indigo-600 dark:text-indigo-400 font-medium hover:underline" data-i18n="setChange">Set / Change</button>
                    </div>
                </div>

                <!-- Data Management -->
                <div>
                    <h4 class="text-sm font-bold uppercase text-gray-500 mb-3" data-i18n="data">Data</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="app.exportJSON()" class="flex items-center justify-center gap-2 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <i class="fa-solid fa-file-export text-indigo-500"></i>
                            <span class="text-sm font-medium dark:text-white" data-i18n="backupJson">Backup JSON</span>
                        </button>
                        <button onclick="document.getElementById('import-file').click()" class="flex items-center justify-center gap-2 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <i class="fa-solid fa-file-import text-green-500"></i>
                            <span class="text-sm font-medium dark:text-white" data-i18n="restoreJson">Restore JSON</span>
                        </button>
                        <button onclick="document.getElementById('import-csv-file').click()" class="col-span-2 flex items-center justify-center gap-2 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <i class="fa-solid fa-file-csv text-yellow-500"></i>
                            <span class="text-sm font-medium dark:text-white" data-i18n="importCsv">Import CSV</span>
                        </button>
                        <input type="file" id="import-file" class="hidden" accept=".json" onchange="app.importJSON(this)">
                        <input type="file" id="import-csv-file" class="hidden" accept=".csv" onchange="app.importCSV(this)">
                    </div>
                </div>

                <!-- Custom Categories -->
                <div>
                    <h4 class="text-sm font-bold uppercase text-gray-500 mb-3" data-i18n="categories">Categories</h4>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="new-cat-input" placeholder="New category name" class="flex-1 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg px-3 py-2 text-sm dark:text-white focus:outline-none focus:border-indigo-500">
                        <button onclick="app.addCategory()" class="bg-indigo-600 text-white px-4 rounded-lg hover:bg-indigo-700"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div id="settings-cat-list" class="flex flex-wrap gap-2">
                        <!-- Cats injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="bg-white dark:bg-dark-card border-b border-gray-200 dark:border-gray-700 px-6 py-4 flex justify-between items-center shrink-0 z-10 transition-colors">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-lg shadow-indigo-500/30">
                <i class="fa-solid fa-wallet"></i>
            </div>
            <h1 class="text-xl font-bold text-gray-900 dark:text-white tracking-tight" data-i18n="appTitle">PocketTracker</h1>
            <span class="text-indigo-500 text-xs uppercase align-top font-bold" data-i18n="pro">PRO</span>
        </div>
        <div class="flex items-center gap-4">
            <div id="user-info" class="text-sm font-medium text-gray-500 dark:text-gray-400 hidden md:block" data-i18n="connecting">Connecting...</div>
            <button onclick="app.toggleDarkMode()" class="text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" title="Toggle Dark Mode">
                <i class="fa-solid fa-moon dark:hidden"></i>
                <i class="fa-solid fa-sun hidden dark:block text-yellow-400"></i>
            </button>
            <button onclick="app.toggleSettings()" class="text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" title="Settings">
                <i class="fa-solid fa-gear"></i>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        
        <!-- Loading Overlay -->
        <div id="loading-overlay" class="absolute inset-0 bg-white dark:bg-dark-bg z-40 flex flex-col items-center justify-center transition-colors">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
            <p class="text-gray-500 dark:text-gray-400" data-i18n="syncing">Syncing your finances...</p>
        </div>

        <!-- Left Panel: Form & Stats -->
        <div class="w-full md:w-5/12 lg:w-4/12 flex flex-col border-e border-gray-200 dark:border-gray-700 bg-white dark:bg-dark-card overflow-y-auto custom-scrollbar transition-colors">
            
            <!-- Balance Card -->
            <div class="p-6 bg-gradient-to-br from-indigo-600 to-purple-700 text-white shrink-0 relative overflow-hidden group">
                <div class="absolute top-0 end-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i class="fa-solid fa-chart-pie text-9xl"></i>
                </div>
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-1">
                        <p class="text-indigo-100 text-sm font-medium" data-i18n="totalBalance">Total Balance</p>
                        <select id="account-filter" onchange="app.setAccountFilter(this.value)" class="bg-white/20 border-none text-xs rounded px-2 py-1 text-white focus:outline-none cursor-pointer">
                            <option value="all" data-i18n="allAccounts">All Accounts</option>
                            <option value="Cash" data-i18n="accCash">Cash</option>
                            <option value="Bank" data-i18n="accBank">Bank</option>
                            <option value="Card" data-i18n="accCard">Card</option>
                        </select>
                    </div>
                    <h2 id="total-balance" class="text-4xl font-bold mb-6">Rs 0</h2>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white/10 rounded-lg p-3 backdrop-blur-sm border border-white/10">
                            <div class="flex items-center gap-2 text-green-300 mb-1">
                                <i class="fa-solid fa-arrow-down text-xs"></i>
                                <span class="text-xs font-bold uppercase" data-i18n="income">Income</span>
                            </div>
                            <p id="total-income" class="text-lg font-semibold">Rs 0</p>
                        </div>
                        <div class="bg-white/10 rounded-lg p-3 backdrop-blur-sm border border-white/10">
                            <div class="flex items-center gap-2 text-red-300 mb-1">
                                <i class="fa-solid fa-arrow-up text-xs"></i>
                                <span class="text-xs font-bold uppercase" data-i18n="expense">Expense</span>
                            </div>
                            <p id="total-expense" class="text-lg font-semibold">Rs 0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Savings Goals Section -->
            <div class="px-6 pt-6 pb-2 border-b border-gray-100 dark:border-gray-700">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-gray-900 dark:text-white flex items-center gap-2 text-sm">
                        <i class="fa-solid fa-piggy-bank text-pink-500"></i> <span data-i18n="savingsGoals">Savings Goals</span>
                    </h3>
                    <button onclick="app.addSavingsGoal()" class="text-xs bg-pink-100 dark:bg-pink-900 text-pink-600 dark:text-pink-300 px-2 py-1 rounded hover:bg-pink-200 dark:hover:bg-pink-800 transition-colors" data-i18n="addGoal">
                        + Add Goal
                    </button>
                </div>
                <div id="savings-list" class="space-y-3">
                    <!-- Savings items injected here -->
                </div>
            </div>

            <!-- Debts & Loans Section -->
            <div class="px-6 pt-6 pb-2 border-b border-gray-100 dark:border-gray-700">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-gray-900 dark:text-white flex items-center gap-2 text-sm">
                        <i class="fa-solid fa-hand-holding-dollar text-orange-500"></i> <span data-i18n="debtsLoans">Debts & Loans</span>
                    </h3>
                    <button onclick="app.addDebt()" class="text-xs bg-orange-100 dark:bg-orange-900 text-orange-600 dark:text-orange-300 px-2 py-1 rounded hover:bg-orange-200 dark:hover:bg-orange-800 transition-colors" data-i18n="addDebt">
                        + Record
                    </button>
                </div>
                <div id="debts-list" class="space-y-3">
                    <!-- Debt items injected here -->
                </div>
            </div>

            <!-- Form -->
            <div class="p-6">
                <h3 id="form-title" class="font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-circle-plus text-indigo-600 dark:text-indigo-400"></i> <span data-i18n="newTransaction">New Transaction</span>
                </h3>
                
                <form id="transaction-form" class="space-y-4">
                    <input type="hidden" id="edit-id" value="">
                    
                    <!-- Description with Voice, Camera & Receipt -->
                    <div class="relative">
                        <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1" data-i18n="description">Description</label>
                        <div class="flex gap-2">
                            <input type="text" id="desc" required placeholder="e.g., Grocery Shopping" 
                                class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 dark:text-white transition-all">
                            
                            <!-- Mic Button -->
                            <button type="button" onclick="app.startVoiceEntry()" id="mic-btn" class="bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300 w-10 shrink-0 rounded-lg hover:bg-indigo-100 dark:hover:bg-indigo-900 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors flex items-center justify-center" title="Voice Input">
                                <i class="fa-solid fa-microphone"></i>
                            </button>

                            <!-- Camera Button -->
                            <button type="button" onclick="app.startCamera()" id="camera-btn" class="bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300 w-10 shrink-0 rounded-lg hover:bg-indigo-100 dark:hover:bg-indigo-900 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors flex items-center justify-center" title="Take Photo">
                                <i class="fa-solid fa-camera"></i>
                            </button>
                            
                            <!-- Receipt Upload Button -->
                            <button type="button" onclick="document.getElementById('receipt-input').click()" id="receipt-btn" class="bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300 w-10 shrink-0 rounded-lg hover:bg-indigo-100 dark:hover:bg-indigo-900 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors flex items-center justify-center" title="Attach Receipt">
                                <i class="fa-solid fa-paperclip"></i>
                            </button>
                            <input type="file" id="receipt-input" accept="image/*" class="hidden" onchange="app.handleReceiptSelect(this)">
                        </div>
                        <div id="receipt-preview" class="hidden text-xs text-indigo-600 dark:text-indigo-400 mt-1 flex items-center gap-1">
                            <i class="fa-solid fa-check"></i> <span data-i18n="receiptAttached">Receipt Attached</span> 
                            <button type="button" onclick="app.clearReceipt()" class="text-red-500 hover:text-red-700 ms-2"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1" data-i18n="amount">Amount</label>
                            <input type="number" id="amount" required step="1" min="0" placeholder="0" 
                                class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 dark:text-white transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1" data-i18n="date">Date</label>
                            <input type="date" id="date" required 
                                class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 dark:text-white transition-all text-gray-600 dark:text-gray-300">
                        </div>
                    </div>

                    <!-- Type & Account -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1" data-i18n="type">Type</label>
                            <select id="type" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg px-4 py-2.5 dark:text-white cursor-pointer">
                                <option value="expense" data-i18n="expense">Expense</option>
                                <option value="income" data-i18n="income">Income</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1" data-i18n="account">Account</label>
                            <select id="account" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg px-4 py-2.5 dark:text-white cursor-pointer">
                                <option value="Cash" data-i18n="accCash">Cash</option>
                                <option value="Bank" data-i18n="accBank">Bank</option>
                                <option value="Card" data-i18n="accCard">Card</option>
                            </select>
                        </div>
                    </div>

                    <!-- Category & Recurring -->
                    <div>
                         <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1" data-i18n="category">Category</label>
                         <select id="category" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg px-4 py-2.5 dark:text-white cursor-pointer">
                            <!-- Populated by JS -->
                        </select>
                    </div>

                    <div class="flex items-center gap-2 pt-1">
                        <input type="checkbox" id="recurring" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600">
                        <label for="recurring" class="text-sm text-gray-600 dark:text-gray-400" data-i18n="recurring">Recurring Monthly</label>
                    </div>

                    <div class="flex gap-2">
                        <button type="submit" id="submit-btn" 
                            class="flex-1 bg-gray-900 dark:bg-indigo-600 hover:bg-gray-800 dark:hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg shadow-lg shadow-gray-900/10 dark:shadow-indigo-900/20 transition-all transform active:scale-95" data-i18n="addTransaction">
                            Add Transaction
                        </button>
                        <button type="button" id="cancel-edit-btn" onclick="app.cancelEdit()" class="hidden w-24 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-semibold py-3 rounded-lg transition-all" data-i18n="cancel">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Right Panel: List & Visualization -->
        <div class="flex-1 bg-gray-50 dark:bg-dark-bg flex flex-col h-full overflow-hidden transition-colors">
            
            <!-- Visualization Panel -->
            <div class="p-6 shrink-0 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-dark-card transition-colors">
                
                <div class="flex flex-col md:flex-row gap-4 justify-between items-start md:items-center mb-6">
                    <h3 class="font-bold text-gray-900 dark:text-white text-lg" data-i18n="analytics">Analytics & Budgets</h3>
                    
                    <div class="flex flex-wrap gap-2 w-full md:w-auto">
                        <div class="relative grow md:grow-0">
                            <i class="fa-solid fa-magnifying-glass absolute start-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                            <input type="text" id="search-input" placeholder="Search..." oninput="app.handleSearch(this.value)"
                                class="w-full md:w-40 ps-8 pe-3 py-1.5 text-sm bg-gray-100 dark:bg-gray-800 border-none rounded-full focus:ring-2 focus:ring-indigo-500 dark:text-white transition-all">
                        </div>
                        <select id="date-filter" onchange="app.setDateFilter(this.value)" class="px-3 py-1.5 text-sm bg-gray-100 dark:bg-gray-800 border-none rounded-full focus:ring-2 focus:ring-indigo-500 text-gray-700 dark:text-gray-300 cursor-pointer">
                            <option value="all" data-i18n="allTime">All Time</option>
                            <option value="this-month" data-i18n="thisMonth">This Month</option>
                            <option value="last-month" data-i18n="lastMonth">Last Month</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Doughnut -->
                    <div class="h-40 relative flex justify-center items-center">
                        <canvas id="expenseChart"></canvas>
                        <div id="no-data-msg" class="absolute inset-0 flex items-center justify-center text-gray-400 text-xs hidden text-center px-2" data-i18n="noExpenses">No expenses</div>
                    </div>
                    
                    <!-- Line Trend -->
                    <div class="h-40 relative hidden md:block">
                        <canvas id="trendChart"></canvas>
                    </div>
                    
                    <!-- Budgets -->
                    <div class="space-y-3 h-40 overflow-y-auto custom-scrollbar pe-2">
                        <div class="flex justify-between items-end mb-1 sticky top-0 bg-white dark:bg-dark-card z-10 pb-1">
                            <span class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide" data-i18n="catLimits">Category Limits</span>
                            <button onclick="app.setBudget()" class="text-xs text-indigo-600 dark:text-indigo-400 hover:underline" data-i18n="set">Set</button>
                        </div>
                        <div id="budget-bars" class="space-y-3"></div>
                    </div>
                </div>
            </div>

            <!-- Main View Container (List vs Calendar) -->
            <div class="flex-1 overflow-hidden flex flex-col p-6">
                <div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-50 dark:bg-dark-bg py-2 z-10 transition-colors">
                    <div class="flex gap-2 items-center">
                        <h3 class="font-bold text-gray-900 dark:text-white" data-i18n="transactions">Transactions</h3>
                        <div class="flex bg-gray-200 dark:bg-gray-700 rounded-lg p-0.5">
                            <button onclick="app.setView('list')" id="btn-list" class="px-3 py-1 text-xs rounded-md bg-white dark:bg-gray-600 shadow-sm transition-all"><i class="fa-solid fa-list"></i></button>
                            <button onclick="app.setView('calendar')" id="btn-cal" class="px-3 py-1 text-xs rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 transition-all"><i class="fa-solid fa-calendar"></i></button>
                        </div>
                    </div>
                    
                    <div class="flex gap-1" id="list-filters">
                         <button onclick="app.setTypeFilter('all')" class="filter-btn active px-3 py-1 text-xs rounded-full font-medium transition-colors bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300" data-i18n="all">All</button>
                         <button onclick="app.setTypeFilter('income')" class="filter-btn px-3 py-1 text-xs rounded-full font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" data-i18n="income">Income</button>
                         <button onclick="app.setTypeFilter('expense')" class="filter-btn px-3 py-1 text-xs rounded-full font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" data-i18n="expense">Expense</button>
                    </div>
                </div>
                
                <!-- List View -->
                <div id="transaction-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-3 pb-10">
                    <!-- Transactions injected here -->
                </div>

                <!-- Calendar View -->
                <div id="calendar-view" class="hidden flex-1 overflow-y-auto custom-scrollbar bg-white dark:bg-dark-card rounded-xl p-4 shadow-sm border border-gray-200 dark:border-gray-700">
                    <div id="calendar-header" class="grid grid-cols-7 gap-1 mb-2 text-center text-xs font-bold text-gray-500 uppercase">
                        <!-- Days injected by JS -->
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, updateDoc, doc, serverTimestamp, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Config ---
        const userConfig = {
            apiKey: "AIzaSyBZachSPlBNmKFgVrCSUQXkK_nmn70zIXo",
            authDomain: "enermatrix-bdf38.firebaseapp.com",
            databaseURL: "https://enermatrix-bdf38-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "enermatrix-bdf38",
            storageBucket: "enermatrix-bdf38.firebasestorage.app",
            messagingSenderId: "915323020088",
            appId: "1:915323020088:web:4c239e2169cd3af014d7cd",
            measurementId: "G-ZQ3W51VTYS"
        };

        // Fallback for demo environment
        const firebaseConfig = Object.keys(userConfig).length > 0 ? userConfig : (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {});
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let firebaseApp, auth, db, storage;

        // --- Translations ---
        const translations = {
            en: {
                appTitle: "PocketTracker",
                pro: "PRO",
                connecting: "Connecting...",
                synced: "Synced",
                offlineMode: "Offline Mode",
                syncing: "Syncing your finances...",
                totalBalance: "Total Balance",
                income: "Income",
                expense: "Expense",
                savingsGoals: "Savings Goals",
                addGoal: "+ Add Goal",
                debtsLoans: "Debts & Loans",
                addDebt: "+ Record",
                payable: "Payable (I Owe)",
                receivable: "Receivable (Owes Me)",
                person: "Person",
                newTransaction: "New Transaction",
                description: "Description",
                amount: "Amount",
                date: "Date",
                type: "Type",
                account: "Account",
                category: "Category",
                recurring: "Recurring Monthly",
                addTransaction: "Add Transaction",
                cancel: "Cancel",
                update: "Update",
                analytics: "Analytics & Budgets",
                transactions: "Transactions",
                all: "All",
                allTime: "All Time",
                thisMonth: "This Month",
                lastMonth: "Last Month",
                catLimits: "Category Limits",
                set: "Set",
                noExpenses: "No expenses",
                settings: "Settings",
                security: "Security",
                appPin: "App PIN",
                protectData: "Protect your data",
                setChange: "Set / Change",
                data: "Data",
                backupJson: "Backup JSON",
                restoreJson: "Restore JSON",
                importCsv: "Import CSV",
                categories: "Categories",
                privacyLock: "Privacy Lock",
                enterPin: "Enter your PIN to access",
                unlock: "Unlock",
                accCash: "Cash",
                accBank: "Bank",
                accCard: "Card",
                allAccounts: "All Accounts",
                noData: "No data",
                receiptAttached: "Receipt Attached",
                csvSuccess: "CSV imported successfully!",
                csvError: "Invalid CSV. Format: Date,Description,Type,Category,Amount",
                settle: "Settle/Pay",
                days: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
                
                // Categories
                Food: "Food", Transport: "Transport", Housing: "Housing", Utilities: "Utilities",
                Health: "Health", Entertainment: "Entertainment", Salary: "Salary",
                Freelance: "Freelance", Shopping: "Shopping", Other: "Other"
            },
            ur: {
                appTitle: "جیبی ٹریکر",
                pro: "پرو",
                connecting: "منسلک ہو رہا ہے...",
                synced: "ہم آہنگ",
                offlineMode: "آف لائن موڈ",
                syncing: "آپ کے مالیات کو مطابقت پذیر کر رہا ہے...",
                totalBalance: "کل بیلنس",
                income: "آمدنی",
                expense: "اخراجات",
                savingsGoals: "بچت کے اہداف",
                addGoal: "ہدف شامل کریں +",
                debtsLoans: "قرضہ جات",
                addDebt: "ریکارڈ +",
                payable: "میں نے دینا ہے",
                receivable: "مجھ سے لیا",
                person: "شخص",
                newTransaction: "نیا لین دین",
                description: "تفصیل",
                amount: "رقم",
                date: "تاریخ",
                type: "قسم",
                account: "اکاؤنٹ",
                category: "زمرہ",
                recurring: "ماہانہ تکرار",
                addTransaction: "شامل کریں",
                cancel: "منسوخ",
                update: "اپ ڈیٹ",
                analytics: "تجزیات اور بجٹ",
                transactions: "لین دین",
                all: "سب",
                allTime: "تمام وقت",
                thisMonth: "اس مہینے",
                lastMonth: "پچھلے مہینے",
                catLimits: "زمرہ کی حدود",
                set: "سیٹ کریں",
                noExpenses: "کوئی اخراجات نہیں",
                settings: "ترتیبات",
                security: "سیکیورٹی",
                appPin: "ایپ پن",
                protectData: "اپنے ڈیٹا کی حفاظت کریں",
                setChange: "سیٹ / تبدیل کریں",
                data: "ڈیٹا",
                backupJson: "بیک اپ JSON",
                restoreJson: "بحال کریں JSON",
                importCsv: "CSV درآمد کریں",
                categories: "زمرہ جات",
                privacyLock: "پرائیویسی لاک",
                enterPin: "رسائی کے لیے اپنا پن درج کریں",
                unlock: "ان لاک",
                accCash: "نقد",
                accBank: "بینک",
                accCard: "کارڈ",
                allAccounts: "تمام اکاؤنٹس",
                noData: "کوئی ڈیٹا نہیں",
                receiptAttached: "رسید منسلک ہے",
                csvSuccess: "CSV کامیابی سے درآمد ہو گئی!",
                csvError: "غلط فارمیٹ۔ ترتیب: تاریخ، تفصیل، قسم، زمرہ، رقم",
                days: ["اتوار", "پیر", "منگل", "بدھ", "جمعرات", "جمعہ", "ہفتہ"],
                
                // Categories
                Food: "خوراک", Transport: "ٹرانسپورٹ", Housing: "رہائش", Utilities: "سہولیات",
                Health: "صحت", Entertainment: "تفریح", Salary: "تنخواہ",
                Freelance: "فری لانس", Shopping: "خریداری", Other: "دیگر"
            }
        };

        try {
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) throw new Error("Missing Config");
            firebaseApp = initializeApp(firebaseConfig);
            auth = getAuth(firebaseApp);
            db = getFirestore(firebaseApp);
            storage = getStorage(firebaseApp);
        } catch(e) {
            console.warn("Connection Error:", e);
            alert("Connection to database failed. Please check your internet.");
        }

        class ExpenseTracker {
            constructor() {
                this.transactions = [];
                this.savings = [];
                this.debts = [];
                this.budgets = {};
                this.categories = []; // No predefined categories
                
                // State
                this.lang = 'en';
                this.typeFilter = 'all';
                this.dateFilter = 'this-month'; // Changed default
                this.accountFilter = 'all';
                this.searchQuery = '';
                this.viewMode = 'list';
                this.currentReceiptBase64 = null;
                this.isLoginMode = true; // Auth Modal state
                this.cameraStream = null;
                this.hasCheckedMonth = false; // Flag to check month only once
                
                this.chart = null;
                this.trendChart = null;
                this.currentUser = null;
                this.editingId = null;

                this.currencyFormatter = new Intl.NumberFormat('en-PK', {
                    style: 'currency',
                    currency: 'PKR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });

                this.initTheme();
                this.applyLanguage();
                this.bindEvents();
                this.checkPin();
            }

            t(key) {
                return translations[this.lang][key] || key;
            }

            toggleLanguage() {
                this.lang = this.lang === 'en' ? 'ur' : 'en';
                localStorage.setItem('app_lang', this.lang);
                this.applyLanguage();
                this.updateUI(); // Re-render lists/charts with new lang
                this.renderCategoryOptions();
                this.renderSavings();
                this.renderDebts();
                this.updateBudgetBars();
            }

            applyLanguage() {
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    el.textContent = this.t(key);
                });

                document.getElementById('desc').placeholder = 'e.g., Grocery Shopping';
                document.getElementById('search-input').placeholder = this.t('analytics').split(' ')[0] + '...';
                document.getElementById('new-cat-input').placeholder = 'New category name';
            }

            initTheme() {
                if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }

            bindEvents() {
                document.getElementById('transaction-form').addEventListener('submit', (e) => this.handleSubmit(e));
                document.getElementById('auth-form').addEventListener('submit', (e) => this.handleAuthSubmit(e));
                
                const dateInput = document.getElementById('date');
                if(dateInput) dateInput.valueAsDate = new Date();
                
                const pinInput = document.getElementById('pin-input');
                pinInput.addEventListener('input', (e) => {
                    if (e.target.value.length === 4) this.verifyPin();
                });
                
                window.app = this;
            }

            checkPin() {
                const pin = localStorage.getItem('app_pin');
                if (pin) {
                    document.getElementById('pin-overlay').classList.remove('hidden');
                    document.getElementById('pin-overlay').classList.add('flex');
                    document.getElementById('pin-input').focus();
                } else {
                    this.initAuth();
                }
            }

            verifyPin() {
                const storedPin = localStorage.getItem('app_pin');
                const input = document.getElementById('pin-input').value;
                if (input === storedPin) {
                    document.getElementById('pin-overlay').classList.add('hidden');
                    this.initAuth();
                } else {
                    document.getElementById('pin-input').classList.add('border-red-500');
                    setTimeout(() => document.getElementById('pin-input').classList.remove('border-red-500'), 500);
                    document.getElementById('pin-input').value = '';
                }
            }

            setPin() {
                const promptMsg = "Enter new 4-digit PIN (leave empty to remove):";
                const newPin = prompt(promptMsg);
                if (newPin === null) return;
                if (newPin === "") {
                    localStorage.removeItem('app_pin');
                    alert("PIN removed.");
                } else if (newPin.length === 4 && !isNaN(newPin)) {
                    localStorage.setItem('app_pin', newPin);
                    alert("PIN set successfully.");
                } else {
                    alert("Invalid PIN. Must be 4 digits.");
                }
                this.toggleSettings();
            }

            // --- AUTH ---
            async initAuth() {
                const overlay = document.getElementById('loading-overlay');
                
                setTimeout(() => { if (overlay && !overlay.classList.contains('hidden')) overlay.classList.add('hidden'); }, 4000);

                try {
                    // Try to restore session or use custom token if provided
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    }
                } catch (error) {
                    console.error("Auth Error:", error);
                }

                onAuthStateChanged(auth, (user) => {
                    this.currentUser = user;
                    this.handleUserLogin();
                });
            }

            handleUserLogin() {
                const overlay = document.getElementById('loading-overlay');
                const userInfo = document.getElementById('user-info');
                const settingsUser = document.getElementById('settings-user-details');
                const settingsBtn = document.getElementById('settings-auth-btn');

                if (this.currentUser) {
                    const status = this.t('synced');
                    const color = 'bg-green-100 text-green-700';
                    const display = this.currentUser.email || (this.currentUser.isAnonymous ? 'Guest' : 'User');
                    
                    userInfo.innerHTML = `<span class="${color} px-2 py-1 rounded text-xs ms-2">● ${status}</span> ${display.slice(0, 10)}`;
                    
                    // Settings Panel Update
                    settingsUser.innerHTML = `<p class="font-medium dark:text-white">${display}</p><p class="text-xs text-gray-500">${this.currentUser.uid.slice(0,6)}...</p>`;
                    settingsBtn.textContent = 'Logout';
                    settingsBtn.onclick = () => this.handleLogout();

                    this.loadData();
                    this.loadSavings();
                    this.loadDebts();
                    this.loadSettings();
                    document.getElementById('auth-modal').classList.add('hidden');
                    
                    setTimeout(() => overlay.classList.add('hidden'), 500);
                } else {
                    userInfo.textContent = 'Login Required';
                    settingsUser.innerHTML = `<p class="font-medium dark:text-white">Guest</p><p class="text-xs text-gray-500">Not synced</p>`;
                    settingsBtn.textContent = 'Login';
                    settingsBtn.onclick = () => this.showAuthModal();
                    
                    // Force Login
                    this.showAuthModal(); 
                    
                    overlay.classList.add('hidden');
                }
            }

            showAuthModal() {
                document.getElementById('auth-modal').classList.remove('hidden');
                document.getElementById('settings-modal').classList.add('hidden');
                this.isLoginMode = true;
                this.updateAuthUI();
            }

            toggleAuthMode() {
                this.isLoginMode = !this.isLoginMode;
                this.updateAuthUI();
            }

            updateAuthUI() {
                const title = document.getElementById('auth-title');
                const btn = document.getElementById('auth-submit-btn');
                const switchText = document.getElementById('auth-switch-text');
                const switchBtn = document.getElementById('auth-switch-btn');
                const error = document.getElementById('auth-error');
                const forgotBtn = document.getElementById('auth-forgot-pass');
                
                error.classList.add('hidden');
                
                if (this.isLoginMode) {
                    title.textContent = 'Login to Sync';
                    btn.textContent = 'Login';
                    switchText.textContent = "Don't have an account?";
                    switchBtn.textContent = "Sign Up";
                    if(forgotBtn) forgotBtn.classList.remove('hidden');
                } else {
                    title.textContent = 'Create Account';
                    btn.textContent = 'Sign Up';
                    switchText.textContent = "Already have an account?";
                    switchBtn.textContent = "Login";
                    if(forgotBtn) forgotBtn.classList.add('hidden');
                }
            }

            async handleForgotPassword() {
                const email = document.getElementById('auth-email').value;
                if (!email) {
                    const errorEl = document.getElementById('auth-error');
                    errorEl.textContent = "Please enter your email to reset password.";
                    errorEl.classList.remove('hidden');
                    return;
                }
                
                try {
                    await sendPasswordResetEmail(auth, email);
                    alert("Password reset email sent to " + email);
                } catch (error) {
                    console.error("Reset Error:", error);
                    alert(error.message);
                }
            }

            async handleAuthSubmit(e) {
                e.preventDefault();
                const email = document.getElementById('auth-email').value;
                const pass = document.getElementById('auth-password').value;
                const errorEl = document.getElementById('auth-error');
                const btn = document.getElementById('auth-submit-btn');
                
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
                btn.disabled = true;
                errorEl.classList.add('hidden');

                try {
                    if (this.isLoginMode) {
                        await signInWithEmailAndPassword(auth, email, pass);
                    } else {
                        await createUserWithEmailAndPassword(auth, email, pass);
                    }
                    // Success handled by onAuthStateChanged
                } catch (error) {
                    console.error("Auth Error:", error);
                    let msg = error.message;
                    
                    // Improved Error Handling
                    if (error.code === 'auth/operation-not-allowed') {
                        msg = "Error: Email/Password sign-in is not enabled in Firebase Console.";
                    } else if (error.code === 'auth/email-already-in-use') {
                        msg = "Email is already registered. Try logging in.";
                    } else if (error.code === 'auth/weak-password') {
                        msg = "Password is too weak. Use at least 6 characters.";
                    } else if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        msg = "Invalid email or password.";
                    }

                    errorEl.textContent = msg;
                    errorEl.classList.remove('hidden');
                    btn.textContent = this.isLoginMode ? 'Login' : 'Sign Up';
                    btn.disabled = false;
                }
            }

            async handleLogout() {
                await signOut(auth);
                window.location.reload(); // Simple reload to clear state
            }

            // --- DATA LOADING ---

            loadData() {
                if (!this.currentUser) return;
                const path = ['artifacts', appId, 'users', this.currentUser.uid, 'expenses'];
                
                if (path) {
                    const q = collection(db, ...path);
                    onSnapshot(q, (snapshot) => {
                        this.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        this.transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                        this.updateUI();
                    });
                }
            }

            loadSavings() {
                if (this.currentUser) {
                    onSnapshot(collection(db, 'artifacts', appId, 'users', this.currentUser.uid, 'savings'), (snapshot) => {
                        this.savings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        this.renderSavings();
                    });
                }
            }

            loadDebts() {
                if (this.currentUser) {
                    onSnapshot(collection(db, 'artifacts', appId, 'users', this.currentUser.uid, 'debts'), (snapshot) => {
                        this.debts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        this.renderDebts();
                    });
                }
            }

            loadSettings() {
                if (this.currentUser) {
                    const docRef = doc(db, 'artifacts', appId, 'users', this.currentUser.uid, 'settings', 'config');
                    onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            this.budgets = data.budgets || {};
                            if(data.categories) {
                                this.categories = data.categories;
                            } else {
                                this.categories = ['Food', 'Transport', 'Housing', 'Utilities', 'Health', 'Entertainment', 'Salary', 'Freelance', 'Shopping', 'Other']; 
                            }
                            
                            // Check for New Month logic
                            if (!this.hasCheckedMonth && this.transactions.length > 0) {
                                this.checkNewMonth(data.lastProcessedMonth);
                            }
                        }
                        this.renderCategoryOptions();
                        this.updateBudgetBars();
                    });
                }
            }

            async saveSettings() {
                const settings = { budgets: this.budgets, categories: this.categories };
                if (this.currentUser) {
                    try {
                        await setDoc(doc(db, 'artifacts', appId, 'users', this.currentUser.uid, 'settings', 'config'), settings, { merge: true });
                    } catch (error) {
                        console.error("Save settings error:", error);
                        alert("Failed to save settings: " + error.message);
                    }
                }
            }

            renderCategoryOptions() {
                const select = document.getElementById('category');
                const currentVal = select.value;
                
                if (this.categories.length === 0) {
                    select.innerHTML = `<option value="" disabled selected>No categories - Add in Settings</option>`;
                } else {
                    select.innerHTML = this.categories.map(c => `<option value="${c}">${this.t(c) || c}</option>`).join('');
                }
                
                if(this.categories.includes(currentVal)) select.value = currentVal;
                
                const list = document.getElementById('settings-cat-list');
                list.innerHTML = this.categories.length === 0 
                    ? `<span class="text-xs text-gray-400 italic">No categories defined</span>`
                    : this.categories.map(c => `
                    <div class="flex items-center gap-1 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-xs dark:text-white">
                        ${this.t(c)||c} <button onclick="app.removeCategory('${c}')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                `).join('');
            }

            addCategory() {
                const input = document.getElementById('new-cat-input');
                const val = input.value.trim();
                if(val && !this.categories.includes(val)) {
                    this.categories.push(val);
                    // Optimistic update
                    this.renderCategoryOptions();
                    this.saveSettings().catch(() => {
                        // Revert on failure
                        this.categories = this.categories.filter(c => c !== val);
                        this.renderCategoryOptions();
                    });
                    input.value = '';
                }
            }

            removeCategory(cat) {
                if(confirm(`Delete category "${cat}"?`)) {
                    const oldCats = [...this.categories];
                    this.categories = this.categories.filter(c => c !== cat);
                    // Optimistic update
                    this.renderCategoryOptions();
                    this.saveSettings().catch(() => {
                        // Revert
                        this.categories = oldCats;
                        this.renderCategoryOptions();
                    });
                }
            }

            // --- CAMERA ---
            async startCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    const video = document.getElementById('camera-feed');
                    video.srcObject = stream;
                    document.getElementById('camera-modal').classList.remove('hidden');
                    this.cameraStream = stream;
                } catch (err) {
                    alert("Camera access denied or not available. Please ensure you are using HTTPS or Localhost.");
                    console.error(err);
                }
            }

            closeCamera() {
                const modal = document.getElementById('camera-modal');
                modal.classList.add('hidden');
                if (this.cameraStream) {
                    this.cameraStream.getTracks().forEach(track => track.stop());
                    this.cameraStream = null;
                }
            }

            capturePhoto() {
                const video = document.getElementById('camera-feed');
                if (!video.videoWidth) return;

                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 800;
                const scale = MAX_WIDTH / video.videoWidth;
                canvas.width = Math.min(MAX_WIDTH, video.videoWidth);
                canvas.height = video.videoHeight * (canvas.width / video.videoWidth);
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const base64 = canvas.toDataURL('image/jpeg', 0.6);
                this.currentReceiptBase64 = base64;
                document.getElementById('receipt-preview').classList.remove('hidden');
                this.closeCamera();
            }

            // --- RECEIPT & IMAGES ---
            handleReceiptSelect(input) {
                const file = input.files[0];
                if (!file) return;
                
                this.compressImage(file).then(base64 => {
                    this.currentReceiptBase64 = base64;
                    document.getElementById('receipt-preview').classList.remove('hidden');
                });
            }

            clearReceipt() {
                this.currentReceiptBase64 = null;
                document.getElementById('receipt-input').value = '';
                document.getElementById('receipt-preview').classList.add('hidden');
            }

            compressImage(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 800;
                            const scale = MAX_WIDTH / img.width;
                            canvas.width = Math.min(MAX_WIDTH, img.width);
                            canvas.height = img.height * (canvas.width / img.width);
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            resolve(canvas.toDataURL('image/jpeg', 0.6));
                        };
                    };
                });
            }

            // --- NEW: Upload to Firebase Storage ---
            async uploadImage(base64Data) {
                if(!auth.currentUser) return null;
                if(!storage) throw new Error("Storage not initialized");
                
                // Create unique filename
                const filename = `receipts/${auth.currentUser.uid}/${Date.now()}.jpg`;
                const storageRef = ref(storage, filename);
                
                // Upload string (Base64)
                await uploadString(storageRef, base64Data, 'data_url');
                
                // Get URL
                return await getDownloadURL(storageRef);
            }

            viewReceipt(urlOrBase64) {
                document.getElementById('receipt-image-view').src = urlOrBase64;
                document.getElementById('receipt-modal').classList.remove('hidden');
            }

            // --- VOICE ---
            startVoiceEntry() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    alert("Voice recognition not supported.");
                    return;
                }
                
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.lang = 'en-US';
                
                const btn = document.getElementById('mic-btn');
                btn.classList.add('text-red-500', 'animate-pulse');

                recognition.onresult = (event) => {
                    const text = event.results[0][0].transcript;
                    this.parseVoiceCommand(text);
                    btn.classList.remove('text-red-500', 'animate-pulse');
                };
                
                recognition.onerror = () => btn.classList.remove('text-red-500', 'animate-pulse');
                recognition.start();
            }

            parseVoiceCommand(text) {
                const expenseMatch = text.match(/(\d+)/); 
                if (expenseMatch) {
                    document.getElementById('amount').value = expenseMatch[1];
                    document.getElementById('desc').value = text.replace(expenseMatch[1], '').trim();
                } else {
                    document.getElementById('desc').value = text;
                }
            }

            capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

            async handleSubmit(e) {
                e.preventDefault();
                if (!this.currentUser) return;

                const btn = document.getElementById('submit-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
                btn.disabled = true;

                // Handle Image Upload
                let receiptValue = this.currentReceiptBase64;
                
                // If it's new Base64 data and we are online, upload to Storage
                if (receiptValue && receiptValue.startsWith('data:image') && this.currentUser) {
                    try {
                        btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up fa-spin"></i> Uploading Image...';
                        
                        // Safety timeout for upload (15 seconds)
                        const uploadPromise = this.uploadImage(receiptValue);
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error("Upload timed out. Check network or Storage rules.")), 15000)
                        );
                        
                        receiptValue = await Promise.race([uploadPromise, timeoutPromise]);
                    } catch(err) {
                        console.error("Upload failed", err);
                        // Fallback: If upload fails, ask user or just save without. 
                        // For UX, we just alert and save without to prevent data loss of the transaction details.
                        alert("Image upload failed (" + err.message + "). Saving transaction without receipt.");
                        receiptValue = null; 
                    }
                }

                const data = {
                    description: document.getElementById('desc').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    date: document.getElementById('date').value,
                    type: document.getElementById('type').value,
                    category: document.getElementById('category').value, 
                    account: document.getElementById('account').value,
                    recurring: document.getElementById('recurring').checked,
                    receipt: receiptValue, // Now stores URL (online) or Base64 (offline)
                    updatedAt: serverTimestamp()
                };

                try {
                    const colRef = collection(db, 'artifacts', appId, 'users', this.currentUser.uid, 'expenses');
                    if (this.editingId) {
                        await updateDoc(doc(colRef, this.editingId), data);
                    } else {
                        data.createdAt = serverTimestamp();
                        await addDoc(colRef, data);
                    }
                    
                    this.cancelEdit();
                    document.getElementById('date').value = data.date;
                } catch (error) {
                    console.error(error);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

            async deleteTransaction(id) {
                if (!confirm('Delete this transaction?')) return;
                if(this.currentUser) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', this.currentUser.uid, 'expenses', id));
                }
            }

            editTransaction(id) {
                const tx = this.transactions.find(t => t.id === id);
                if (!tx) return;
                this.editingId = id;
                document.getElementById('form-title').innerHTML = `<i class="fa-solid fa-pen-to-square"></i> Edit`;
                document.getElementById('submit-btn').textContent = this.t('update');
                document.getElementById('cancel-edit-btn').classList.remove('hidden');
                
                // Manual mapping to ensure IDs match Data Keys
                document.getElementById('desc').value = tx.description || '';
                document.getElementById('amount').value = tx.amount || '';
                document.getElementById('date').value = tx.date || '';
                document.getElementById('type').value = tx.type || 'expense';
                document.getElementById('category').value = tx.category || '';
                document.getElementById('account').value = tx.account || 'Cash';
                
                document.getElementById('recurring').checked = !!tx.recurring;
                
                if (tx.receipt) {
                    this.currentReceiptBase64 = tx.receipt;
                    document.getElementById('receipt-preview').classList.remove('hidden');
                } else {
                    this.clearReceipt();
                }
                
                // Scroll to top
                document.querySelector('.w-full.md\\:w-5\\/12').scrollTop = 0;
            }

            cancelEdit() {
                this.editingId = null;
                document.getElementById('transaction-form').reset();
                this.clearReceipt();
                document.getElementById('date').valueAsDate = new Date();
                document.getElementById('form-title').innerHTML = `<i class="fa-solid fa-circle-plus"></i> <span data-i18n="newTransaction">${this.t('newTransaction')}</span>`;
                document.getElementById('submit-btn').textContent = this.t('addTransaction');
                document.getElementById('cancel-edit-btn').classList.add('hidden');
            }

            async addSavingsGoal() {
                const name = prompt("Goal Name:"); if(!name) return;
                const target = parseFloat(prompt("Target Amount (Rs):")); if(isNaN(target)) return;
                const goal = { name, target, current: 0 };
                
                if(this.currentUser) {
                    await addDoc(collection(db, 'artifacts', appId, 'users', this.currentUser.uid, 'savings'), goal);
                }
            }
            
            async updateSavings(id, amount) {
                if(this.currentUser) {
                    const s = this.savings.find(s => s.id === id);
                    if(s) await updateDoc(doc(db, 'artifacts', appId, 'users', this.currentUser.uid, 'savings', id), { current: Math.max(0, (s.current||0)+amount) });
                }
            }

            async deleteSavings(id) {
                if(!confirm("Delete?")) return;
                if(this.currentUser) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', this.currentUser.uid, 'savings', id));
                }
            }

            renderSavings() {
                const c = document.getElementById('savings-list');
                c.innerHTML = this.savings.length ? '' : `<p class="text-xs text-gray-400 italic">No goals yet</p>`;
                this.savings.forEach(s => {
                    const pct = Math.min(100, Math.round((s.current/s.target)*100));
                    c.innerHTML += `
                        <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg border border-gray-100 dark:border-gray-700">
                            <div class="flex justify-between mb-1 text-sm dark:text-white font-semibold">
                                <span>${s.name}</span>
                                <span class="text-gray-500 font-mono text-xs">${this.formatCompact(s.current)}/${this.formatCompact(s.target)}</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-2"><div class="bg-pink-500 h-2 rounded-full transition-all" style="width:${pct}%"></div></div>
                            <div class="flex justify-end gap-2 text-[10px]">
                                <button onclick="app.updateSavings('${s.id}', 500)" class="bg-white dark:bg-gray-600 px-2 rounded border dark:border-gray-500 dark:text-white">+500</button>
                                <button onclick="app.updateSavings('${s.id}', 1000)" class="bg-white dark:bg-gray-600 px-2 rounded border dark:border-gray-500 dark:text-white">+1k</button>
                                <button onclick="app.deleteSavings('${s.id}')" class="text-red-400 ms-1"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>`;
                });
            }

            async addDebt() {
                const typeInput = prompt("Type (1: I Borrowed, 2: I Lent):");
                if(!typeInput || (typeInput !== '1' && typeInput !== '2')) return;
                
                const type = typeInput === '1' ? 'payable' : 'receivable';
                const person = prompt("Person Name:");
                if(!person) return;
                
                const amount = parseFloat(prompt("Amount (Rs):"));
                if(isNaN(amount)) return;

                const debt = {
                    person, amount, type, date: new Date().toISOString()
                };

                if(this.currentUser) {
                    await addDoc(collection(db, 'artifacts', appId, 'users', this.currentUser.uid, 'debts'), debt);
                }
                
                // Optional: Create Transaction Record
                if(confirm("Update Wallet Balance? (Record as Transaction)")) {
                    const txData = {
                        description: `${type==='payable'?'Borrowed from':'Lent to'} ${person}`,
                        amount: amount,
                        date: new Date().toISOString().split('T')[0],
                        type: type === 'payable' ? 'income' : 'expense', // Borrowing increases cash (Income), Lending decreases cash (Expense)
                        category: 'Other',
                        account: 'Cash', // Default
                        recurring: false,
                        receipt: null,
                        updatedAt: serverTimestamp()
                    };
                    if(this.currentUser) {
                         const colRef = collection(db, 'artifacts', appId, 'users', this.currentUser.uid, 'expenses');
                         txData.createdAt = serverTimestamp();
                         await addDoc(colRef, txData);
                    }
                }
            }

            async editDebt(id) {
                const debt = this.debts.find(d => d.id === id);
                if (!debt) return;

                const typeInput = prompt(this.t('addDebt') + " - Type (1: I Borrowed, 2: I Lent):", debt.type === 'payable' ? '1' : '2');
                if(!typeInput || (typeInput !== '1' && typeInput !== '2')) return;
                
                const type = typeInput === '1' ? 'payable' : 'receivable';
                const person = prompt(this.t('person') + ":", debt.person);
                if(!person) return;
                
                const amount = parseFloat(prompt(this.t('amount') + ":", debt.amount));
                if(isNaN(amount)) return;

                if (this.currentUser) {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', this.currentUser.uid, 'debts', id), {
                        person, amount, type
                    });
                }
            }
            
            async settleDebt(id) {
                const debt = this.debts.find(d => d.id === id);
                if (!debt) return;

                const amountStr = prompt(`Enter amount to pay/settle (Total: ${this.currencyFormatter.format(debt.amount)}):`, debt.amount);
                if (amountStr === null) return; // User cancelled

                const settleAmount = parseFloat(amountStr);
                if (isNaN(settleAmount) || settleAmount <= 0) {
                    alert("Please enter a valid positive amount.");
                    return;
                }

                if (settleAmount > debt.amount) {
                    alert(`Amount cannot exceed the total debt of ${this.currencyFormatter.format(debt.amount)}.`);
                    return;
                }

                const remaining = debt.amount - settleAmount;
                const isFullPayment = remaining <= 0;

                // Update Debt Record
                if (this.currentUser) {
                    if (isFullPayment) {
                        await deleteDoc(doc(db, 'artifacts', appId, 'users', this.currentUser.uid, 'debts', id));
                    } else {
                        await updateDoc(doc(db, 'artifacts', appId, 'users', this.currentUser.uid, 'debts', id), {
                            amount: remaining
                        });
                    }
                }

                // Record Transaction
                if (confirm(`Record payment of ${this.currencyFormatter.format(settleAmount)} in transactions?`)) {
                    const txData = {
                        description: `${debt.type === 'payable' ? 'Repaid' : 'Received from'} ${debt.person} ${isFullPayment ? '(Settled)' : '(Partial)'}`,
                        amount: settleAmount,
                        date: new Date().toISOString().split('T')[0],
                        type: debt.type === 'payable' ? 'expense' : 'income',
                        category: 'Other',
                        account: 'Cash', // Defaulting to Cash, ideally could ask, but keeping it simple
                        recurring: false,
                        receipt: null,
                        updatedAt: serverTimestamp()
                    };

                    if (this.currentUser) {
                        const colRef = collection(db, 'artifacts', appId, 'users', this.currentUser.uid, 'expenses');
                        txData.createdAt = serverTimestamp();
                        await addDoc(colRef, txData);
                    }
                }
            }

            renderDebts() {
                const c = document.getElementById('debts-list');
                c.innerHTML = this.debts.length ? '' : `<p class="text-xs text-gray-400 italic">No records</p>`;
                
                this.debts.forEach(d => {
                    const isPayable = d.type === 'payable'; // I owe
                    const color = isPayable ? 'text-red-500' : 'text-green-500';
                    const icon = isPayable ? 'fa-arrow-down' : 'fa-arrow-up';
                    const label = isPayable ? this.t('payable') : this.t('receivable');
                    
                    c.innerHTML += `
                        <div class="bg-white dark:bg-gray-800 p-2 rounded border border-gray-200 dark:border-gray-700 flex justify-between items-center group">
                            <div>
                                <p class="text-sm font-semibold dark:text-white flex items-center gap-1">
                                    <i class="fa-solid ${icon} ${color} text-xs"></i> ${d.person}
                                </p>
                                <p class="text-[10px] text-gray-400">${label}</p>
                            </div>
                            <div class="text-right flex items-center gap-2">
                                <p class="text-sm font-bold ${color}">${this.formatCompact(d.amount)}</p>
                                <button onclick="app.editDebt('${d.id}')" class="text-[10px] bg-gray-100 dark:bg-gray-700 hover:bg-indigo-100 dark:hover:bg-indigo-900 text-gray-500 hover:text-indigo-600 px-2 py-0.5 rounded transition-colors" title="Edit">
                                    <i class="fa-solid fa-pencil"></i>
                                </button>
                                <button onclick="app.settleDebt('${d.id}')" class="text-[10px] bg-gray-100 dark:bg-gray-700 hover:bg-green-100 dark:hover:bg-green-900 text-gray-500 hover:text-green-600 px-2 py-0.5 rounded transition-colors" title="${this.t('settle')}">
                                    <i class="fa-solid fa-check"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            }

            async setBudget() {
                const cat = prompt("Category Name (e.g. Food):"); if(!cat) return;
                const amt = parseFloat(prompt("Limit (Rs):")); if(isNaN(amt)) return;
                this.budgets[cat] = amt;
                this.saveSettings();
            }

            updateBudgetBars() {
                const c = document.getElementById('budget-bars');
                if(!Object.keys(this.budgets).length) { c.innerHTML = `<p class="text-xs text-gray-400">No limits set</p>`; return; }
                c.innerHTML = '';
                
                const now = new Date();
                const spending = {};
                this.transactions.filter(t => {
                    const d = new Date(t.date);
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear() && t.type === 'expense';
                }).forEach(t => spending[t.category] = (spending[t.category]||0) + t.amount);

                Object.entries(this.budgets).forEach(([cat, limit]) => {
                    const spent = spending[cat]||0;
                    const pct = Math.min(100, (spent/limit)*100);
                    const color = pct >= 100 ? 'bg-red-500' : (pct > 75 ? 'bg-yellow-500' : 'bg-green-500');
                    c.innerHTML += `
                        <div class="text-xs">
                            <div class="flex justify-between mb-1 dark:text-gray-300"><span>${this.t(cat)||cat}</span><span>${this.formatCompact(spent)}/${this.formatCompact(limit)}</span></div>
                            <div class="w-full bg-gray-100 dark:bg-gray-700 rounded-full h-1.5"><div class="${color} h-1.5 rounded-full" style="width:${pct}%"></div></div>
                        </div>`;
                });
            }

            exportJSON() {
                const data = { transactions: this.transactions, savings: this.savings, budgets: this.budgets, categories: this.categories };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `pocket_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            }

            importJSON(input) {
                const file = input.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if(confirm("Overwrite current data? Continue?")) {
                            if(data.categories) this.categories = data.categories;
                            if(data.budgets) this.budgets = data.budgets;
                            this.saveSettings();
                            alert("Settings restored.");
                        }
                    } catch(err) { alert("Invalid JSON"); }
                };
                reader.readAsText(file);
            }

            importCSV(input) {
                const file = input.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n');
                        let count = 0;
                        
                        // Start batch (simulated by looping for offline/simple demo)
                        for (let i = 0; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if(!line || i === 0 && line.toLowerCase().includes('date')) continue; // Skip header
                            
                            // Simple CSV parse (robust regex for quoted strings)
                            const parts = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                            if(parts && parts.length >= 5) {
                                // Clean quotes
                                const clean = parts.map(p => p.replace(/^"|"$/g, ''));
                                const data = {
                                    date: clean[0],
                                    description: clean[1],
                                    type: clean[2].toLowerCase(),
                                    category: clean[3],
                                    amount: parseFloat(clean[4]),
                                    account: 'Cash', // Default
                                    updatedAt: new Date().toISOString()
                                };
                                
                                if(this.currentUser) {
                                    data.createdAt = serverTimestamp();
                                    await addDoc(collection(db, 'artifacts', appId, 'users', this.currentUser.uid, 'expenses'), data);
                                }
                                count++;
                            }
                        }
                        
                        alert(this.t('csvSuccess') + ` (${count})`);
                        this.toggleSettings();
                    } catch(err) { 
                        console.error(err);
                        alert(this.t('csvError')); 
                    }
                };
                reader.readAsText(file);
            }

            setTypeFilter(type) { this.typeFilter = type; this.updateUI(); }
            setDateFilter(val) { this.dateFilter = val; this.updateUI(); }
            setAccountFilter(val) { this.accountFilter = val; this.updateUI(); }
            handleSearch(val) { this.searchQuery = val.toLowerCase(); this.updateUI(); }
            setView(mode) { 
                this.viewMode = mode; 
                document.getElementById('transaction-list').classList.toggle('hidden', mode !== 'list');
                document.getElementById('calendar-view').classList.toggle('hidden', mode !== 'calendar');
                document.getElementById('list-filters').classList.toggle('hidden', mode !== 'list');
                
                document.getElementById('btn-list').className = mode === 'list' ? "px-3 py-1 text-xs rounded-md bg-white dark:bg-gray-600 shadow-sm transition-all" : "px-3 py-1 text-xs rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 transition-all";
                document.getElementById('btn-cal').className = mode === 'calendar' ? "px-3 py-1 text-xs rounded-md bg-white dark:bg-gray-600 shadow-sm transition-all" : "px-3 py-1 text-xs rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 transition-all";
                
                if(mode === 'calendar') this.renderCalendar();
            }
            toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }
            toggleDarkMode() { 
                document.documentElement.classList.toggle('dark'); 
                localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            }

            getFilteredTransactions() {
                let f = this.transactions;
                if(this.accountFilter !== 'all') f = f.filter(t => (t.account || 'Cash') === this.accountFilter);
                return f;
            }

            updateUI() {
                const accountTx = this.getFilteredTransactions();
                
                // 1. Calculate Global Balance (All time for selected account)
                const totalBalance = accountTx.reduce((acc, t) => acc + (t.type==='income'?t.amount:-t.amount), 0);
                
                // 2. Apply Date & Search Filters for View
                let viewTx = accountTx;
                const now = new Date();
                if(this.dateFilter === 'this-month') {
                    viewTx = viewTx.filter(t => {
                        const d = new Date(t.date);
                        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    });
                }
                if(this.dateFilter === 'last-month') { 
                    const lm = new Date(); 
                    lm.setMonth(now.getMonth()-1); 
                    // Handle year wrap for Jan -> Dec
                    if(now.getMonth() === 0) lm.setFullYear(now.getFullYear() - 1);
                    
                    viewTx = viewTx.filter(t => {
                        const d = new Date(t.date);
                        return d.getMonth() === lm.getMonth() && d.getFullYear() === lm.getFullYear();
                    }); 
                }
                
                if(this.searchQuery) {
                    viewTx = viewTx.filter(t => t.description.toLowerCase().includes(this.searchQuery) || this.t(t.category).toLowerCase().includes(this.searchQuery));
                }

                // 3. Calculate Period Income/Expense (Based on viewTx)
                const inc = viewTx.filter(t=>t.type==='income').reduce((acc,t)=>acc+t.amount,0);
                const exp = viewTx.filter(t=>t.type==='expense').reduce((acc,t)=>acc+t.amount,0);

                // 4. Update DOM
                document.getElementById('total-balance').textContent = this.currencyFormatter.format(totalBalance);
                document.getElementById('total-income').textContent = `+${this.currencyFormatter.format(inc)}`;
                document.getElementById('total-expense').textContent = `${this.currencyFormatter.format(exp)}`;

                // 5. Update Charts & List
                this.updateCharts(viewTx);
                if(this.typeFilter !== 'all') viewTx = viewTx.filter(t => t.type === this.typeFilter);
                this.renderList(viewTx);
                if(this.viewMode === 'calendar') this.renderCalendar();
            }

            renderList(txs) {
                const l = document.getElementById('transaction-list');
                l.innerHTML = txs.length ? '' : `<div class="text-center py-8 text-gray-400 opacity-50"><i class="fa-solid fa-receipt text-3xl"></i><p>${this.t('noData')}</p></div>`;
                
                txs.forEach(t => {
                    const isInc = t.type === 'income';
                    const icon = this.getCategoryIcon(t.category);
                    const accIcon = t.account === 'Bank' ? 'fa-building-columns' : (t.account === 'Card' ? 'fa-credit-card' : 'fa-money-bill');
                    
                    l.innerHTML += `
                        <div class="bg-white dark:bg-dark-card p-4 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm flex justify-between items-center group fade-in">
                            <div class="flex items-center gap-4">
                                <div class="h-10 w-10 rounded-full ${isInc?'bg-green-50 text-green-600':'bg-red-50 text-red-600'} flex items-center justify-center text-lg"><i class="${icon}"></i></div>
                                <div>
                                    <h4 class="font-semibold dark:text-white leading-tight flex items-center gap-2">
                                        ${t.description} 
                                        ${t.recurring?'<i class="fa-solid fa-rotate-right text-indigo-400 text-[10px]"></i>':''}
                                        ${t.receipt ? `<button onclick="app.viewReceipt('${t.receipt}')" class="text-gray-400 hover:text-indigo-500"><i class="fa-solid fa-paperclip text-xs"></i></button>` : ''}
                                    </h4>
                                    <div class="flex gap-2 text-xs text-gray-400 mt-1">
                                        <span class="bg-gray-100 dark:bg-gray-700 px-2 rounded-full">${this.t(t.category)||t.category}</span>
                                        <span><i class="fa-solid ${accIcon} mx-1"></i>${this.t('acc'+(t.account||'Cash'))}</span>
                                        <span>${new Date(t.date).toLocaleDateString()}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="font-bold ${isInc?'text-green-600':'text-red-600'}">${isInc?'+':'-'}${this.currencyFormatter.format(t.amount)}</span>
                                <div class="opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                                    <button onclick="app.editTransaction('${t.id}')" class="w-7 h-7 rounded-full hover:bg-indigo-50 text-gray-400 hover:text-indigo-600"><i class="fa-solid fa-pencil text-xs"></i></button>
                                    <button onclick="app.deleteTransaction('${t.id}')" class="w-7 h-7 rounded-full hover:bg-red-50 text-gray-400 hover:text-red-600"><i class="fa-solid fa-trash text-xs"></i></button>
                                </div>
                            </div>
                        </div>`;
                });
            }
            
            renderCalendar() {
                const header = document.getElementById('calendar-header');
                const days = this.t('days');
                header.innerHTML = days.map(d => `<div>${d}</div>`).join('');
                
                const grid = document.getElementById('calendar-grid');
                grid.innerHTML = '';
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                
                // Empty slots
                for(let i=0; i<firstDay.getDay(); i++) grid.innerHTML += '<div></div>';
                
                for(let d=1; d<=lastDay.getDate(); d++) {
                    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const dayTx = this.transactions.filter(t => t.date === dateStr);
                    const dayTotal = dayTx.filter(t=>t.type==='expense').reduce((a,b)=>a+b.amount,0);
                    
                    grid.innerHTML += `
                        <div class="calendar-day border border-gray-100 dark:border-gray-700 rounded p-1 text-right flex flex-col justify-between ${dayTotal>0?'bg-red-50/50 dark:bg-red-900/10':''}">
                            <span class="text-xs text-gray-500 font-medium">${d}</span>
                            ${dayTotal > 0 ? `<span class="text-[10px] font-bold text-red-500">-${this.formatCompact(dayTotal)}</span>` : ''}
                        </div>`;
                }
            }

            initChart() {
                this.chart = new Chart(document.getElementById('expenseChart').getContext('2d'), {
                    type: 'doughnut',
                    data: { labels: [], datasets: [{ data: [], backgroundColor: ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#3b82f6'], borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '70%' }
                });
                
                this.trendChart = new Chart(document.getElementById('trendChart').getContext('2d'), {
                    type: 'line',
                    data: { labels: [], datasets: [{ label: 'Daily Spending', data: [], borderColor: '#6366f1', tension: 0.4, fill: true, backgroundColor: 'rgba(99, 102, 241, 0.1)' }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { display: false } } }
                });
            }

            updateCharts(txs) {
                if(!this.chart) this.initChart();
                const exp = txs.filter(t => t.type === 'expense');
                
                const cats = {}; exp.forEach(t => cats[this.t(t.category)||t.category] = (cats[this.t(t.category)||t.category]||0)+t.amount);
                this.chart.data.labels = Object.keys(cats);
                this.chart.data.datasets[0].data = Object.values(cats);
                this.chart.update();
                document.getElementById('no-data-msg').classList.toggle('hidden', exp.length > 0);
                document.getElementById('no-data-msg').textContent = this.t('noExpenses');
                
                const days = {}; exp.forEach(t => days[t.date] = (days[t.date]||0)+t.amount);
                const sortedDates = Object.keys(days).sort();
                this.trendChart.data.labels = sortedDates;
                this.trendChart.data.datasets[0].data = sortedDates.map(d => days[d]);
                this.trendChart.update();
            }

            getCategoryIcon(cat) {
                const map = { 'Food':'fa-utensils', 'Transport':'fa-car', 'Housing':'fa-house', 'Utilities':'fa-bolt', 'Health':'fa-heart-pulse', 'Entertainment':'fa-gamepad', 'Salary':'fa-money-bill-wave', 'Shopping':'fa-bag-shopping' };
                return `fa-solid ${map[cat] || 'fa-tag'}`;
            }
            
            formatCompact(n) { return new Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 1 }).format(n); }

            // --- NEW MONTH LOGIC ---
            checkNewMonth(lastMonth) {
                const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
                this.hasCheckedMonth = true; // Prevent re-running

                if (lastMonth && lastMonth !== currentMonth) {
                    // Calculate Balance
                    const totalBalance = this.transactions.reduce((acc, t) => acc + (t.type==='income'?t.amount:-t.amount), 0);
                    
                    if (totalBalance > 0) {
                        document.getElementById('nm-balance').textContent = this.currencyFormatter.format(totalBalance);
                        document.getElementById('new-month-modal').classList.remove('hidden');
                        document.getElementById('new-month-modal').classList.add('flex');
                    } else {
                        // If balance is 0 or negative, just update the month silently
                        this.updateLastProcessedMonth(currentMonth);
                    }
                } else if (!lastMonth) {
                    // First run, just set current month
                    this.updateLastProcessedMonth(currentMonth);
                }
            }

            async handleNewMonth(action) {
                const currentMonth = new Date().toISOString().slice(0, 7);
                const totalBalance = this.transactions.reduce((acc, t) => acc + (t.type==='income'?t.amount:-t.amount), 0);
                
                if (action === 'save') {
                    // 1. Create Expense to zero out balance
                    const txData = {
                        description: `Monthly Savings Transfer (${new Date().toLocaleDateString('default', { month: 'long', year: 'numeric' })})`,
                        amount: totalBalance,
                        date: new Date().toISOString().split('T')[0],
                        type: 'expense',
                        category: 'Other', // Use 'Other' or 'Savings' if available
                        account: 'Bank', // Defaulting to Bank
                        recurring: false,
                        receipt: null,
                        updatedAt: serverTimestamp(),
                        createdAt: serverTimestamp()
                    };
                    
                    // 2. Add to Savings Goal (Create one if missing)
                    const savingsGoal = this.savings.find(s => s.name === "General Savings");
                    
                    try {
                        // Add Transaction
                        await addDoc(collection(db, 'artifacts', appId, 'users', this.currentUser.uid, 'expenses'), txData);
                        
                        // Update/Create Savings
                        if (savingsGoal) {
                             await updateDoc(doc(db, 'artifacts', appId, 'users', this.currentUser.uid, 'savings', savingsGoal.id), {
                                current: (savingsGoal.current || 0) + totalBalance
                            });
                        } else {
                            await addDoc(collection(db, 'artifacts', appId, 'users', this.currentUser.uid, 'savings'), {
                                name: "General Savings",
                                target: totalBalance * 12, // Arbitrary target
                                current: totalBalance
                            });
                        }
                    } catch (e) {
                        console.error("Error processing new month:", e);
                        alert("Error saving data.");
                        return;
                    }
                }
                
                // Update settings to remember we handled this month
                await this.updateLastProcessedMonth(currentMonth);
                
                document.getElementById('new-month-modal').classList.add('hidden');
                document.getElementById('new-month-modal').classList.remove('flex');
            }

            async updateLastProcessedMonth(month) {
                if(this.currentUser) {
                    await setDoc(doc(db, 'artifacts', appId, 'users', this.currentUser.uid, 'settings', 'config'), { 
                        lastProcessedMonth: month 
                    }, { merge: true });
                }
            }
        }

        const appInstance = new ExpenseTracker();
    </script>
</body>
</html>
